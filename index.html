<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Evacuation Centers Map</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      background: #f0f4f8;
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
    }

    .card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      max-width: 450px;
      margin: 40px auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    h2 {
      color: #007bff;
      font-size: 1.8em;
      margin-bottom: 20px;
    }

    #map {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      margin-bottom: 20px;
      background: #f5f7fa;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .back-btn {
      background: linear-gradient(135deg, #007bff, #00b3e6);
      color: #fff;
      border: none;
      border-radius: 30px;
      padding: 12px 32px;
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      margin-top: 12px;
    }

    .back-btn:hover {
      background: #005f8b;
      transform: translateY(-2px);
    }

    .back-btn:active {
      transform: translateY(0);
    }

    #nearest-btn {
      background: #28a745;
      display: none;
      transition: background 0.3s;
    }

    #nearest-btn:hover {
      background: #218838;
    }

    @media (max-width: 500px) {
      .card {
        max-width: 98vw;
        padding: 12px;
      }

      #map {
        height: 280px;
      }

      .back-btn {
        font-size: 1em;
        padding: 10px 28px;
      }
    }
  </style>
</head>
<body>

  <div class="card">
    <h2>Evacuation Centers Map</h2>
    <div id="map"></div>
    <button class="back-btn" onclick="closePage()">Phivolcs Observation Records</button>
    <button id="nearest-btn" class="back-btn" onclick="navigateToNearest()">Navigate to Nearest Center</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var locations = [
      { coords: [13.9380069, 121.1183754], name: 'Transville Covered Court' },
      { coords: [13.9519, 121.1147], name: 'Barangay Dos Evacuation Center' },
      { coords: [13.915468, 121.123745], name: 'Lifa City Evacuation Center' },
      { coords: [13.935641, 121.118405], name: 'Rafael M. Lojo Memorial School' },
      { coords: [13.962922, 121.174253], name: 'Kolehiyo ng Lungsod ng Lipa' },
      { coords: [14.1069294, 121.1391833], name: 'Evacuation Center of Sto. Tomas Batangas' },
      { coords: [14.093593, 121.028934], name: 'Tumaway Evacuation Center, Talisay' },
      { coords: [13.769563, 121.053045], name: 'Batangas City Evacuation Center' },
      { coords: [14.124012, 120.988848], name: 'Tagaytay City Permanent Evacuation Center' },
      { coords: [14.385894, 120.901966], name: 'Evacuation Center For Taal Eruption - Barangay Navarro' },
      { coords: [13.650179, 121.208105], name: 'Disaster Operation Evacuation Center' },
      { coords: [13.867908, 120.968928], name: 'Calayaan Evacuation and Sports Center' },
      { coords: [13.861683, 120.969332], name: 'Pacifico Evacuation and Sport Center' },
      { coords: [13.861145, 120.961874], name: 'Sampa Evacuation and Sport Center' },
      { coords: [13.790709, 121.405998], name: 'San Juan Evacuation Center' },
      { coords: [14.019728, 120.731035], name: 'TUY Evacuation Center' },
    ];

    var map;
    var userLatLng = null;
    var nearestLoc = null;

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        userLatLng = [position.coords.latitude, position.coords.longitude];
        map = L.map('map').setView(userLatLng, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap'
        }).addTo(map);

        var userMarker = L.marker(userLatLng, {
          icon: L.icon({
            iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            shadowSize: [41, 41]
          })
        }).addTo(map);
        userMarker.bindPopup('<b>Your Location</b>').openPopup();

        locations.forEach(function(loc) {
          var marker = L.marker(loc.coords).addTo(map);
          var gmapsUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + loc.coords[0] + ',' + loc.coords[1] + '&travelmode=driving';
          marker.bindPopup(
            '<b>' + loc.name + '</b><br>' +
            '<a href="' + gmapsUrl + '" target="_blank" rel="noopener">Navigate</a>'
          );
        });

        nearestLoc = locations.reduce(function(prev, curr) {
          var prevDist = Math.hypot(prev.coords[0] - userLatLng[0], prev.coords[1] - userLatLng[1]);
          var currDist = Math.hypot(curr.coords[0] - userLatLng[0], curr.coords[1] - userLatLng[1]);
          return (currDist < prevDist) ? curr : prev;
        });
        document.getElementById('nearest-btn').style.display = 'inline-block';
      }, function(error) {
        map = L.map('map').setView(locations[0].coords, 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap'
        }).addTo(map);

        locations.forEach(function(loc) {
          var marker = L.marker(loc.coords).addTo(map);
          var gmapsUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + loc.coords[0] + ',' + loc.coords[1] + '&travelmode=driving';
          marker.bindPopup(
            '<b>' + loc.name + '</b><br>' +
            '<a href="' + gmapsUrl + '" target="_blank" rel="noopener">Navigate</a>'
          );
        });
      });
    } else {
      map = L.map('map').setView(locations[0].coords, 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);

      locations.forEach(function(loc) {
        var marker = L.marker(loc.coords).addTo(map);
        var gmapsUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + loc.coords[0] + ',' + loc.coords[1] + '&travelmode=driving';
        marker.bindPopup(
          '<b>' + loc.name + '</b><br>' +
          '<a href="' + gmapsUrl + '" target="_blank" rel="noopener">Navigate</a>'
        );
      });
    }

    function closePage() {
      window.location.href = 'https://earthquake.phivolcs.dost.gov.ph/';
    }

    function navigateToNearest() {
      if (nearestLoc) {
        var gmapsUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + nearestLoc.coords[0] + ',' + nearestLoc.coords[1] + '&travelmode=driving';
        window.open(gmapsUrl, '_blank');
      }
    }
  </script>
</body>
</html>
